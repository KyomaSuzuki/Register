<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>iPad POS - 日別集計</title>
<link rel="stylesheet" href="style.css" />
</head>
<body>
<header class="topbar">
  <h1>日別集計</h1>
  <nav>
    <a href="index.html">レジに戻る</a>
    <a href="logs.html">会計ログ</a>
  </nav>
</header>

<main class="container">
  <section class="full">
    <div class="controls">
      <button id="btnToday" class="tab active">今日</button>
      <button id="btnYesterday" class="tab">昨日</button>
      <button id="btnAll" class="tab">全期間</button>
    </div>

    <div id="summaryArea" class="summary-card"></div>
  </section>
</main>

<script>
const LOCAL_KEY = 'pos_sales_v1';
const FIXED_COST_PER_DAY = 500;
let sales = JSON.parse(localStorage.getItem(LOCAL_KEY) || '[]');

const summaryArea = document.getElementById('summaryArea');
const btnToday = document.getElementById('btnToday');
const btnYesterday = document.getElementById('btnYesterday');
const btnAll = document.getElementById('btnAll');

function groupByDay(arr){
  const map = {};
  arr.forEach(s=>{
    const day = new Date(s.date).toISOString().slice(0,10);
    map[day] = map[day] || [];
    map[day].push(s);
  });
  return Object.entries(map).map(([day,sl])=> ({day, sales: sl})).sort((a,b)=> b.day.localeCompare(a.day));
}

function calcTotals(list){
  const revenue = list.reduce((s,x)=> s + x.total, 0);
  const cost = list.reduce((s,x)=> s + x.items.reduce((a,b)=> a + b.cost * b.quantity, 0), 0);
  const profit = revenue - cost - FIXED_COST_PER_DAY;
  return { revenue, cost, profit };
}

function render(filter){
  sales = JSON.parse(localStorage.getItem(LOCAL_KEY) || '[]');
  const grouped = groupByDay(sales);
  const today = new Date(); const tStr = today.toISOString().slice(0,10);
  const y = new Date(); y.setDate(today.getDate()-1); const yStr = y.toISOString().slice(0,10);

  let list = [];
  if(filter==='today') list = grouped.filter(g=> g.day === tStr);
  else if(filter==='yesterday') list = grouped.filter(g=> g.day === yStr);
  else list = grouped;

  if(list.length===0) { summaryArea.innerHTML = '<p class="muted">該当するデータがありません</p>'; return; }

  summaryArea.innerHTML = list.map(g=>{
    const totals = calcTotals(g.sales);
    const itemsHtml = g.sales.map(s=>{
      return `<div class="history-row"><div class="time">${new Date(s.date).toLocaleTimeString()}</div><div class="desc">#${s.id} 合計 ¥${s.total}</div></div>`;
    }).join('');
    return `
      <div class="day-block">
        <div class="day-row">
          <div class="day-label">${g.day}</div>
          <div>売上: ¥${totals.revenue}</div>
          <div>純利益: ¥${totals.profit}</div>
        </div>
        <div class="history">${itemsHtml}</div>
      </div>
    `;
  }).join('');
}

btnToday.onclick = ()=> { btnToday.classList.add('active'); btnYesterday.classList.remove('active'); btnAll.classList.remove('active'); render('today'); };
btnYesterday.onclick = ()=> { btnToday.classList.remove('active'); btnYesterday.classList.add('active'); btnAll.classList.remove('active'); render('yesterday'); };
btnAll.onclick = ()=> { btnToday.classList.remove('active'); btnYesterday.classList.remove('active'); btnAll.classList.add('active'); render('all'); };

render('today');
</script>
</body>
</html>
